#! /bin/sh
. /lib/functions.sh

event_btn=$1
event_action=$2
event_time=$3
retval=1

short_press_time=0
long_press_time=0
extra_long_press_time=0

get_press_time() {
	local cfg="$1"
	config_get btn_code "$cfg" btn_code
	if [ "X${btn_code}" = "X0x${event_btn}" ];then
		config_get press_time "$cfg" press_time
		if [ -n "$press_time" ];then
			config_get btn_action "$cfg" btn_action
			if [ "X${btn_action}" = "X1" ];then
				long_press_time=$press_time
			elif [ "X${btn_action}" = "X2" ];then
				short_press_time=$press_time
			elif [ "X${btn_action}" = "X3" ];then
				extra_long_press_time=$press_time
			fi
		fi
	fi
}

comfirm_press_action() {
    if [ "$short_press_time" -eq 0 ] && [ "$long_press_time" -eq 0 ] && [ "$extra_long_press_time" -eq 0 ];then
        short_press_time=4
        long_press_time=12
        extra_long_press_time=12
    fi
	if [ "$event_time" -le "$short_press_time" ]; then
		event_action=2
	elif [ "$event_time" -gt "$short_press_time" ] && [ "$event_time" -le "$long_press_time" ]; then
		event_action=1
	elif [ "$event_time" -gt "$extra_long_press_time" ]; then
		event_action=3
	fi
}

check_btn_event() {
	local cfg="$1"

	config_get btn_code "$cfg" btn_code
	if [ "X${btn_code}" = "X0x${event_btn}" ];then
		config_get btn_action "$cfg" btn_action
		if [ "X${btn_action}" = "X${event_action}" ];then
			config_get btn_cmd "$cfg" btn_cmd
			[ -z ${btn_cmd} ] && return 1
			${btn_cmd}
			retval=0
			return 0
		fi
	fi
}

config_load btn_ctrl_cfg
if [ "X${event_action}" = "X0" ];then
config_foreach get_press_time btn_config
comfirm_press_action
fi
config_foreach check_btn_event btn_config
return ${retval}
